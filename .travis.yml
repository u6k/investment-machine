sudo: required
language: ruby

services:
  - docker

before_install:
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
  - sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
  - sudo apt-get update
  - sudo apt-get -y install docker-ce

script:
  - git clean -xdf
  - mv .env.example .env
  - docker build -t u6kapps/investment-machine -f Dockerfile.production .
  - docker-compose -f docker-compose.production.yml up -d
  - docker-compose -f docker-compose.production.yml exec s3 mkdir /export/investment
  - docker-compose -f docker-compose.production.yml exec app rails test
  - docker-compose -f docker-compose.production.yml down -v

after_success:
  - if [ -n "$TRAVIS_TAG" ]; then
      echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin;
      docker tag u6kapps/investment-machine u6kapps/investment-machine:$TRAVIS_TAG;
      docker push u6kapps/investment-machine;
    else
      echo skip docker push;
    fi

notifications:
  slack:
    secure: i6wGTuyxWwvEDtZzRL99D9Q4iO74bGOwkn+bR6a5gXiFyRkCKO6xGC/Cf6RkEkPKHhph1XLzM9yaTTMUSfc38UGpxUyQTE++QuONGvCRfzKtpayEAYu9hLQC9GmiZbUpw9A7M42/5p5N089bgzNbZ5SFdAMGWEMSOoS1EdfnUlmxNXyaIUekTVjbm3+YeJW80+BGefPVg1OrMc6kZbuhfM5srVSzX9Qs3k6XGhPDlTpBHT+PhDArhaMDNotX3VRWa9gz6FR/N90HfijPYL41hy+K420XsOjbSynEj0surdrn9QzTUI2LWktpaRSj7ACUr7HHG7icxqPqtxRcCQq+x1ae3bKmEvJl0jl1d/yadegG92ylXaNAw8/LvCTYXGUUN2rnK1OiTaSuYDjRclbnBhUzAhiY5m08jjHibFxV5UaL8GfSmCry4pCwig9kb0rNjpZlauZqvfjlTz9IApmXRb31Q2KV6gXx93O8SVDRFVy2sSDcR8tupMjXGHb93oh/ACCkELFqV7vU2m0JB87120UeauxmohyFnogRGv0HolEVb7cRI9gHQF3rhaS9yjH3pM6A+OgXN94N1bXekSCdLBnsGn5n42YzvlYdTJTYvV0XkKkzd860Lqtu8eb4VkxmYFR4d6BLnOq7KbtlluWyo6Jp+0RR7kLhP5cO63w0N9A=
